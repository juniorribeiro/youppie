generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                            String           @id @default(uuid())
  name                          String
  email                         String           @unique
  password_hash                 String
  avatar_url                    String?
  subscription_plan             SubscriptionPlan @default(FREE)
  stripe_customer_id            String?
  stripe_subscription_id        String?
  subscription_status           String?
  subscription_current_period_end DateTime?
  google_analytics_id           String?
  google_tag_manager_id         String?
  facebook_pixel_id             String?
  tracking_head                 String?
  tracking_body                 String?
  tracking_footer               String?
  created_at                    DateTime         @default(now())

  quizzes                       Quiz[]
  tour_completions              TourCompletion[]
  tickets                       Ticket[]
  notifications                 Notification[]
  overrides                     UserOverride[]

  @@map("users")
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  PREMIUM
  ENTERPRISE
}

enum CaptureMode {
  ANONYMOUS
  BEFORE
  AFTER
}

model Quiz {
  id                   String      @id @default(uuid())
  user_id              String
  slug                 String      @unique
  title                String
  description          String?
  language             String      @default("en")
  capture_mode         CaptureMode @default(ANONYMOUS)
  is_published         Boolean     @default(false)
  auto_advance         Boolean     @default(false)
  google_analytics_id  String?
  google_tag_manager_id String?
  facebook_pixel_id    String?
  tracking_head        String?
  tracking_body        String?
  tracking_footer      String?
  created_at           DateTime    @default(now())

  user         User         @relation(fields: [user_id], references: [id])
  steps        Step[]
  leads        Lead[]
  sessions     Session[]
  result_pages ResultPage[]

  @@map("quizzes")
  @@index([user_id])
}

enum StepType {
  QUESTION
  TEXT
  CAPTURE
  RESULT
  INPUT
}

model Step {
  id          String   @id @default(uuid())
  quiz_id     String
  order       Int
  type        StepType
  title       String
  description String?
  image_url   String?
  metadata    Json?

  quiz        Quiz      @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  question    Question?

  @@map("steps")
  @@index([quiz_id])
}

model Question {
  id      String @id @default(uuid())
  step_id String @unique
  text    String

  step    Step           @relation(fields: [step_id], references: [id], onDelete: Cascade)
  options AnswerOption[]

  @@map("questions")
}

model AnswerOption {
  id          String @id @default(uuid())
  question_id String
  text        String
  value       String

  question    Question @relation(fields: [question_id], references: [id], onDelete: Cascade)

  @@map("answer_options")
  @@index([question_id])
}

model Lead {
  id         String   @id @default(uuid())
  quiz_id    String
  name       String?
  email      String
  phone      String?
  created_at DateTime @default(now())

  quiz       Quiz      @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  sessions   Session[]

  @@map("leads")
  @@index([quiz_id])
}

model Session {
  id           String    @id @default(uuid())
  quiz_id      String
  lead_id      String?
  answers      Json      @default("{}")
  score        Int       @default(0)
  completed_at DateTime?

  quiz         Quiz      @relation(fields: [quiz_id], references: [id], onDelete: Cascade)
  lead         Lead?     @relation(fields: [lead_id], references: [id])

  @@map("sessions")
  @@index([quiz_id])
  @@index([lead_id])
}

model ResultPage {
  id                String @id @default(uuid())
  quiz_id           String
  headline_template String
  body_template     String
  cta_text          String
  cta_url           String

  quiz              Quiz   @relation(fields: [quiz_id], references: [id], onDelete: Cascade)

  @@map("result_pages")
  @@index([quiz_id])
}

model TourCompletion {
  id           String   @id @default(uuid())
  user_id      String
  tour_id      String
  completed_at DateTime @default(now())

  user         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, tour_id])
  @@map("tour_completions")
  @@index([user_id])
}

model Admin {
  id           String   @id @default(uuid())
  email        String   @unique
  password_hash String
  name         String
  created_at   DateTime @default(now())

  created_overrides UserOverride[]

  @@map("admins")
}

enum TicketStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

model Ticket {
  id         String         @id @default(uuid())
  user_id    String
  subject    String
  status     TicketStatus   @default(OPEN)
  priority   TicketPriority @default(MEDIUM)
  created_at DateTime       @default(now())
  updated_at DateTime       @default(now()) @updatedAt

  user      User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages  TicketMessage[]

  @@map("tickets")
  @@index([user_id])
  @@index([status])
  @@index([created_at])
}

enum SenderType {
  USER
  ADMIN
}

model TicketMessage {
  id            String     @id @default(uuid())
  ticket_id     String
  sender_type   SenderType
  sender_id     String
  message       String
  attachment_url String?
  created_at    DateTime   @default(now())

  ticket        Ticket     @relation(fields: [ticket_id], references: [id], onDelete: Cascade)

  @@map("ticket_messages")
  @@index([ticket_id])
  @@index([created_at])
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
}

model Notification {
  id         String           @id @default(uuid())
  user_id    String?
  title      String
  message    String
  type       NotificationType @default(INFO)
  is_read    Boolean          @default(false)
  auto_open  Boolean          @default(false)
  created_at DateTime         @default(now())

  user       User?            @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
  @@index([user_id])
  @@index([is_read])
  @@index([created_at])
}

enum OverrideType {
  PLAN_LIMITS
  PREMIUM_FEATURES
  CUSTOM
}

model UserOverride {
  id           String       @id @default(uuid())
  user_id      String
  override_type OverrideType
  expires_at   DateTime?
  metadata     Json?
  created_by   String
  created_at   DateTime     @default(now())

  user         User         @relation(fields: [user_id], references: [id], onDelete: Cascade)
  admin        Admin        @relation(fields: [created_by], references: [id], onDelete: Cascade)

  @@map("user_overrides")
  @@index([user_id])
  @@index([override_type])
  @@index([expires_at])
}

enum AlertType {
  INFO
  WARNING
  CRITICAL
}

model SystemAlert {
  id         String     @id @default(uuid())
  title      String
  message    String
  type       AlertType  @default(INFO)
  dismissible Boolean   @default(true)
  active     Boolean    @default(true)
  created_at DateTime   @default(now())
  updated_at DateTime   @default(now()) @updatedAt

  @@map("system_alerts")
  @@index([active])
  @@index([created_at])
}
