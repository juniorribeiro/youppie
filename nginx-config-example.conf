server {
    server_name quiz.70x7.digital;

    # Headers comuns para todos os proxies
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Rotas da API - sempre fazer proxy para a API (porta 3003)
    # Estas rotas não têm páginas correspondentes no Next.js
    location ~ ^/(quizzes|sessions|steps|health)(/.*)?$ {
        proxy_pass http://127.0.0.1:3003;
    }

    # Rotas de uploads - fazer proxy para a API
    location /uploads/ {
        proxy_pass http://127.0.0.1:3003;
    }

    # Rotas /auth - distinguir entre páginas (GET) e API (POST/PUT/DELETE/PATCH)
    # Métodos POST/PUT/DELETE/PATCH vão para API, GET vai para Next.js
    location /auth/ {
        # Métodos não-GET vão para a API
        if ($request_method !~ ^GET$) {
            proxy_pass http://127.0.0.1:3003;
            break;
        }
        
        # GET vai para Next.js (páginas de login/register)
        proxy_pass http://127.0.0.1:3002;
    }

    # Todas as outras rotas - fazer proxy para Next.js
    location / {
        proxy_pass http://127.0.0.1:3002;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/quiz.70x7.digital/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/quiz.70x7.digital/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = quiz.70x7.digital) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name quiz.70x7.digital;
    return 404; # managed by Certbot
}

